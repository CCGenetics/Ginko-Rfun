---
title: "Processing clean data to extract indicator data"
output:
  html_document:
    df_print: paged
  word_document:
---

This notebook re-formats the data as outputed by Kobo to the shape needed to calculate each of the genetic diversity indicators. For example, in the Kobo output each species assessment is a single row, with population data in different columns, but to estimate the Ne indicator it is needed to have data of each population as a row. This script does that format transformation for you.

Notice that **Nc is not transformed to Ne** at this stage and the **indicator values are not calculated**. This script only re-formats the data from the kobo-output so that you can use these data to estimate the indicators by yourself outside R (e.g. in Excel or other software), or continue to step 3 if you want to use the R functions and standard analyses of this repository.

The input is the "clean kobo output" that was first cleaned in step 1. The output are the indicators data ready to be used to estimate the indicators.

## Variables that need to be set by the user

The file with the kobo clean data (kobo raw output data after quality check of step 1):

```{r}
kobo_clean<-"kobo_output_clean.csv"
```


## Packages and functions

Load required libraries:

```{r, warning=FALSE, message=FALSE}
library(tidyr)
library(dplyr)
library(utile.tools)
library(stringr)
```

Load required functions. These custom fuctions are available at: https://github.com/CCGenetics/Ginko-Rfun

```{r source}
source("get_indicatorNe_data.R")
source("get_indicatorPM_data.R")
source("get_indicatorDNAbased_data.R")
source("get_metadata.R")
source("transform_to_Ne.R")
source("estimate_indicatorNe.R")
```

Other custom functions:
```{r custom_funs}
### not in
'%!in%' <- function(x,y)!('%in%'(x,y))
```

## Get data 

Get indicators and metadata data from clean kobo output:
```{r, echo=TRUE}
# Get data:
kobo_clean<-read.csv(file=kobo_clean, header=TRUE) # variable set at top of script
```

## Extract Indicators data from the raw clean data, and show how it looks.

### Metadata 
Extracts the metadata for taxa and indicators, in some cases creating new useful variables, like taxon name (joining Genus, species, etc) and if the taxon was assessed only a single time or multiple times. Each row is a taxon.

```{r}
# extract metadata, show most relevant columns
metadata<-get_metadata(kobo_output=kobo_clean)
head(metadata[,c("country_assessment", "taxonomic_group" ,"taxon","X_uuid"            , "popsize_data" , "ne_pops_exists")])
```

Some taxa were assessed twice or more times, for example to account for uncertainty on how to divide populations. This information is stored in variable `multiassessment` of the metadata (created by `get_metadata()`). 

Check if there are taxa with multiple assessments in this dataset:

```{r}
metadata %>%
filter(multiassessment=="multiassessment")  %>%
  select(taxonomic_group, taxon, country_assessment, multiassessment) %>%
  arrange(taxon, country_assessment) %>%
  head()
  
```

Alternative assessments allow to account for uncertainty in the number of populations or the size of them. We can examine how the indicators value species by species as done elsewhere in these analyses (see below "Values for indicator Ne and PM for multiassessed species),

### Ne 500 indicator
This step extracts and formats the data needed to estimate the **Ne 500 indicator** (the proportion of populations within species with an effective population size Ne greater than 500). **In the kobo output, population data is in different columns, this function transforms it so that population data is in rows.** This is needed for downstream analyses. 

Example of how the output data looks:
```{r}
# Extract indicator Ne data from kobo output, show most relevant columns:
indNe_data<-get_indicatorNe_data(kobo_output=kobo_clean)
head(indNe_data[,c("taxon", "defined_populations", "population", "Origin", "Ne", "NcType", "NcRange")])

```

Note that if the Population information template was used (species with more than 25 populations) you will need to run an additional step before analysing the data, see below (Getting the population data if the template was used). In the output, each population is a row, and there are as many rows per taxon as there are populations within it. (PENDING TO UPDATE)

### PM indicator
This step outputs a data frame with the data needed to estimate the PM indicator (the proportion of Populations Maintained within species). Each row is a taxon.

Example of how the output data looks:
```{r}
# Extract data to estimate the PM indicator from kobo output, show most relevant columns:
indPM_data<-get_indicatorPM_data(kobo_output=kobo_clean)
head(indPM_data[,c("taxonomic_group", "taxon", "defined_populations", "n_extant_populations","n_extint_populations" )])
```
### DNA-based indicator
This step outputs a data frame with the data needed to estimate the genetic monitoring indicator (number of species in which genetic diversity has been or is being monitored using DNA-based methods). Each row is a taxon.

```{r}
# Extract indicator 3 data from kobo output, show most relevant columns
indDNAbased_data<-get_indicatorDNAbased_data(kobo_output=kobo_clean)
head(indDNAbased_data[,c(1:3, 9:11)])
```

## Save indicators data
You can go ahead and use these data to estimate the indicators by yourself (e.g. in Excel or other software), or you can continue to step 3 if you want to use the R functions and standard analyses of this repository.

Save indicators data and metadata to csv files, useful for analyses outside R.

```{r}
# save processed data
write.csv(indNe_data, "indNe_data.csv", row.names = FALSE)
write.csv(indPM_data, "indPM_data.csv", row.names = FALSE)
write.csv(indDNAbased_data, "indDNAbased_data.csv", row.names = FALSE)
write.csv(metadata, "metadata.csv", row.names = FALSE)

```


## General description of records and taxa assessed by country

(pending)


## Session Info for reproducibility purposes:

```{r}
sessionInfo()
```

